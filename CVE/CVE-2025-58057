#!/bin/bash

set -euo pipefail
. /.functions

VERSION="4.1.125.Final"
ARTIFACT_IDS=(
	io.netty:netty-codec-http2@TELEMETRY_LIBS_DIR
	io.netty:netty-codec-http@TELEMETRY_LIBS_DIR
	io.netty:netty-codec-socks@TELEMETRY_LIBS_DIR
	io.netty:netty-handler-proxy@TELEMETRY_LIBS_DIR

	io.netty:netty-buffer@WEBAPP_LIBS_DIR
	io.netty:netty-codec@WEBAPP_LIBS_DIR
	io.netty:netty-common@WEBAPP_LIBS_DIR
	io.netty:netty-handler@WEBAPP_LIBS_DIR
	io.netty:netty-resolver@WEBAPP_LIBS_DIR
	io.netty:netty-transport@WEBAPP_LIBS_DIR
	io.netty:netty-transport-classes-epoll@WEBAPP_LIBS_DIR
	io.netty:netty-transport-native-epoll@WEBAPP_LIBS_DIR
	io.netty:netty-transport-native-unix-common@WEBAPP_LIBS_DIR

)

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/solr"
set_or_default SERVER_DIR "${HOME_DIR}/server"
set_or_default WEBAPP_DIR "${SERVER_DIR}/solr-webapp/webapp"
set_or_default WEBAPP_LIBS_DIR "${WEBAPP_DIR}/WEB-INF/lib"
set_or_default MODULES_DIR "${HOME_DIR}/modules"
set_or_default TELEMETRY_LIBS_DIR "${MODULES_DIR}/opentelemetry/lib"
set_or_default LICENSES_DIR "${HOME_DIR}/licenses"

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/artemis"
set_or_default LIB_DIR "${HOME_DIR}/lib"

eyes "Applying remediation for CVE-2025-58057"

for ARTIFACT_ID in "${ARTIFACT_IDS[@]}" ; do

	[[ "${ARTIFACT_ID}" =~ ^([^@]+)@([a-zA-Z0-9_]+)$ ]] || continue

	ARTIFACT_ID="${BASH_REMATCH[1]}"
	TGT="${BASH_REMATCH[2]}"
	TGT="${!TGT}"

	FILENAME="${ARTIFACT_ID##*:}"

	find "${TGT}" -type f -name "${FILENAME}-4.*" -delete -print
	mvn-get "${ARTIFACT_ID}:${VERSION}:jar" "${TGT}"

	# Update the license checksums
	find "${LICENSES_DIR}" -type f -name "${FILENAME}-4.*.jar.sha1" -delete -print
	JAR_NAME="${FILENAME}-${VERSION}.jar"
	sha1sum "${TGT}/${JAR_NAME}" | awk '{ print $1 }' > "${LICENSES_DIR}/${JAR_NAME}.sha1"
done

ok "Remediation complete"
