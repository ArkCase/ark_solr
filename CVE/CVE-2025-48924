#!/bin/bash

set -euo pipefail
. /.functions

VERSION="3.18.0"
ARTIFACT="org.apache.commons:commons-lang3:${VERSION}:jar"

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/solr"
set_or_default SERVER_DIR "${HOME_DIR}/server"
set_or_default WEBAPP_DIR "${SERVER_DIR}/solr-webapp/webapp"
set_or_default WEBAPP_LIBS_DIR "${WEBAPP_DIR}/WEB-INF/lib"
set_or_default LICENSES_DIR "${HOME_DIR}/licenses"

eyes "Applying remediation for CVE-2025-48924"

# Update the library
find "${WEBAPP_LIBS_DIR}" -type f -name "commons-lang3-*.jar" -delete -print
mvn-get "${ARTIFACT}" "${WEBAPP_LIBS_DIR}"

# Update the license checksums
find "${LICENSES_DIR}" -type f -name "commons-lang3-*.jar.sha1" -delete -print
JAR_NAME="commons-lang3-${VERSION}.jar"
sha1sum "${WEBAPP_LIBS_DIR}/${JAR_NAME}" | awk '{ print $1 }' > "${LICENSES_DIR}/${JAR_NAME}.sha1"

ok "Remediation complete"
