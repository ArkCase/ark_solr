#!/bin/bash

set -euo pipefail
. /.functions

VERSION="1.11.0"
ARTIFACT="commons-beanutils:commons-beanutils:${VERSION}:jar"

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/solr"
set_or_default CROSS_DC_MANAGER_LIB_DIR "${HOME_DIR}/cross-dc-manager/lib"
set_or_default LICENSES_DIR "${HOME_DIR}/licenses"

eyes "Applying remediation for CVE-2025-48734"

# Update the library
find "${CROSS_DC_MANAGER_LIB_DIR}" -type f -name "commons-beanutils-*.jar" -delete -print
mvn-get "${ARTIFACT}" "${CROSS_DC_MANAGER_LIB_DIR}"

# Update the license checksums
find "${LICENSES_DIR}" -type f -name "commons-beanutils-*.jar.sha1" -delete -print
JAR_NAME="commons-beanutils-${VERSION}.jar"
sha1sum "${CROSS_DC_MANAGER_LIB_DIR}/${JAR_NAME}" | awk '{ print $1 }' > "${LICENSES_DIR}/${JAR_NAME}.sha1"

ok "Remediation complete"
