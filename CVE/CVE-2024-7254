#!/bin/bash

set -euo pipefail
. /.functions

VERSION="3.25.5"
ARTIFACT_IDS=(
	com.google.protobuf:protobuf-java@CROSS_DC_MANAGER_LIB_DIR,EXTRACTION_LIB_DIR,GCS_REPOSITORY_LIB_DIR,TELEMETRY_LIB_DIR,SQL_LIB_DIR
	com.google.protobuf:protobuf-java-util@CROSS_DC_MANAGER_LIB_DIR,GCS_REPOSITORY_LIB_DIR
)

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/solr"
set_or_default CROSS_DC_MANAGER_LIB_DIR "${HOME_DIR}/cross-dc-manager/lib"
set_or_default MODULES_DIR "${HOME_DIR}/modules"
set_or_default EXTRACTION_LIB_DIR "${MODULES_DIR}/extraction/lib"
set_or_default GCS_REPOSITORY_LIB_DIR "${MODULES_DIR}/gcs-repository/lib"
set_or_default TELEMETRY_LIB_DIR "${MODULES_DIR}/opentelemetry/lib"
set_or_default SQL_LIB_DIR "${MODULES_DIR}/sql/lib"
set_or_default LICENSES_DIR "${HOME_DIR}/licenses"

eyes "Applying remediation for CVE-2024-7254"

for ARTIFACT_ID in "${ARTIFACT_IDS[@]}" ; do

	[[ "${ARTIFACT_ID}" =~ ^([^@]+)@([a-zA-Z0-9_,]+)$ ]] || continue

	ARTIFACT_ID="${BASH_REMATCH[1]}"

	TGT_LIST="${BASH_REMATCH[2]}"
	TGT_LIST=( ${TGT_LIST//,/ } )

	FIRST=""
	FILENAME="${ARTIFACT_ID##*:}"
	JAR_NAME="${FILENAME}-${VERSION}.jar"

	for TGT in "${TGT_LIST[@]}" ; do
		TGT="${!TGT}"

		find "${TGT}" -type f -name "${FILENAME}-3.*" -delete -print

		if [ -z "${FIRST}" ] ; then
			mvn-get "${ARTIFACT_ID}:${VERSION}:jar" "${TGT}"
			FIRST="${TGT}/${FILENAME}-${VERSION}.jar"
		else
			ln -vf "${FIRST}" "${TGT}" || cp -vc "${FIRST}" "${TGT}" || fail "Failed to copy or link [${FIRST}] to [${TGT}]"
		fi
	done

	# Update the license checksums
	find "${LICENSES_DIR}" -type f -name "${FILENAME}-3.*.jar.sha1" -delete -print
	sha1sum "${TGT}/${JAR_NAME}" | awk '{ print $1 }' > "${LICENSES_DIR}/${JAR_NAME}.sha1"
done

ok "Remediation complete"
