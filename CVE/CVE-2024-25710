#!/bin/bash

set -euo pipefail
. /.functions

VERSION="1.26.0"
ARTIFACT="org.apache.commons:commons-compress:${VERSION}:jar"

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/solr"
set_or_default MODULES_DIR "${HOME_DIR}/modules"
set_or_default EXTRACTION_LIB_DIR "${MODULES_DIR}/extraction/lib"
set_or_default LICENSES_DIR "${HOME_DIR}/licenses"

eyes "Applying remediation for CVE-2024-25710"

# Update the library
find "${EXTRACTION_LIB_DIR}" -type f -name "commons-compress-*.jar" -delete -print
mvn-get "${ARTIFACT}" "${EXTRACTION_LIB_DIR}"

# Update the license checksums
find "${LICENSES_DIR}" -type f -name "commons-compress-*.jar.sha1" -delete -print
JAR_NAME="commons-compress-${VERSION}.jar"
sha1sum "${EXTRACTION_LIB_DIR}/${JAR_NAME}" | awk '{ print $1 }' > "${LICENSES_DIR}/${JAR_NAME}.sha1"

ok "Remediation complete"
