#!/bin/bash

set -euo pipefail
. /.functions

VERSION="1.79"
GROUP_ID="org.bouncycastle"
BAD_IDS=(
	bcmail-jdk15on
	bcpkix-jdk15on
	bcprov-jdk15on
	bcutil-jdk15on
)
ARTIFACT_IDS=(
	bcmail-jdk18on
	bcpkix-jdk18on
	bcprov-jdk18on
	bcutil-jdk18on
)

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/solr"
set_or_default MODULES_DIR "${HOME_DIR}/modules"
set_or_default EXTRACTION_LIB_DIR "${MODULES_DIR}/extraction/lib"
set_or_default LICENSES_DIR "${HOME_DIR}/licenses"

eyes "Applying remediation for CVE-2025-8916"

for BAD_ID in "${BAD_IDS[@]}" ; do
	find "${EXTRACTION_LIB_DIR}" -type f -name "${BAD_ID}-1.*" -delete -print
	find "${LICENSES_DIR}" -type f -name "${BAD_ID}-1.*.jar.sha1" -delete -print
done

for ARTIFACT_ID in "${ARTIFACT_IDS[@]}" ; do
	mvn-get "${GROUP_ID}:${ARTIFACT_ID}:${VERSION}:jar" "${EXTRACTION_LIB_DIR}"

	FILENAME="${ARTIFACT_ID}"

	# Update the license checksums
	JAR_NAME="${FILENAME}-${VERSION}.jar"
	sha1sum "${EXTRACTION_LIB_DIR}/${JAR_NAME}" | awk '{ print $1 }' > "${LICENSES_DIR}/${JAR_NAME}.sha1"
done
ok "Remediation complete"
