#!/bin/bash

set -euo pipefail
. /.functions

ARTIFACT_IDS=(
	org.bouncycastle:bcmail-jdk18on@EXTRACTION_LIB_DIR
	org.bouncycastle:bcpkix-jdk18on@EXTRACTION_LIB_DIR
	org.bouncycastle:bcprov-jdk18on@EXTRACTION_LIB_DIR
	org.bouncycastle:bcutil-jdk18on@EXTRACTION_LIB_DIR
)

clean_old_and_fix_sum()
{
	local ARTIFACT_ID="${1}"
	local OLD_VERSION="${2}"
	local NEW_VERSION="${3}"
	local NEW_JAR="${4}"

	local OLD_FILENAME="${ARTIFACT_ID##*:}"
	OLD_FILENAME="${OLD_FILENAME//jdk18on/jdk15on}"

	find "${EXTRACTION_LIB_DIR}" -type f -name "${OLD_FILENAME}-1.*" -delete -print
	find "${LICENSES_DIR}" -type f -name "${OLD_FILENAME}-1.*.jar.sha1" -delete -print

	fix-jar-sum "${@}"
}

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/solr"
set_or_default MODULES_DIR "${HOME_DIR}/modules"
set_or_default EXTRACTION_LIB_DIR "${MODULES_DIR}/extraction/lib"
set_or_default LICENSES_DIR "${HOME_DIR}/licenses"

export EXTRACTION_LIB_DIR
export POST_CALL="clean_old_and_fix_sum"
# Have to source b/c of the function
source $(type -P fix-jars) "CVE-2025-8916" "1.79" "${ARTIFACT_IDS[@]}"
