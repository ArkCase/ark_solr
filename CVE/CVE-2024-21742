#!/bin/bash

set -euo pipefail
. /.functions

VERSION="0.8.10"
ARTIFACT_IDS=(
	org.apache.james:apache-mime4j-core
	org.apache.james:apache-mime4j-dom
)

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/solr"
set_or_default MODULES_DIR "${HOME_DIR}/modules"
set_or_default EXTRACTION_LIB_DIR "${MODULES_DIR}/extraction/lib"
set_or_default LICENSES_DIR "${HOME_DIR}/licenses"

eyes "Applying remediation for CVE-2024-21742"

for ARTIFACT_ID in "${ARTIFACT_IDS[@]}" ; do

	FILENAME="${ARTIFACT_ID##*:}"
	JAR_NAME="${FILENAME}-${VERSION}.jar"

	find "${EXTRACTION_LIB_DIR}" -type f -name "${FILENAME}-0.*" -delete -print

	mvn-get "${ARTIFACT_ID}:${VERSION}:jar" "${EXTRACTION_LIB_DIR}"

	# Update the license checksums
	find "${LICENSES_DIR}" -type f -name "${FILENAME}-0.*.jar.sha1" -delete -print
	sha1sum "${EXTRACTION_LIB_DIR}/${JAR_NAME}" | awk '{ print $1 }' > "${LICENSES_DIR}/${JAR_NAME}.sha1"
done

ok "Remediation complete"
