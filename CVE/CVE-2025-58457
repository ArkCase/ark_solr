#!/bin/bash

set -euo pipefail
. /.functions

VERSION="3.9.4"
GROUP_ID="org.apache.zookeeper"
ARTIFACT_IDS=(
	zookeeper
	zookeeper-jute
)

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/solr"
set_or_default SERVER_DIR "${HOME_DIR}/server"
set_or_default WEBAPP_DIR "${SERVER_DIR}/solr-webapp/webapp"
set_or_default WEBAPP_LIBS_DIR "${WEBAPP_DIR}/WEB-INF/lib"
set_or_default LICENSES_DIR "${HOME_DIR}/licenses"

eyes "Applying remediation for CVE-2025-58457"
for ARTIFACT_ID in "${ARTIFACT_IDS[@]}" ; do
	find "${WEBAPP_LIBS_DIR}" -type f -name "${ARTIFACT_ID}-3.*" -delete -print
	mvn-get "${GROUP_ID}:${ARTIFACT_ID}:${VERSION}:jar" "${WEBAPP_LIBS_DIR}"

	FILENAME="${ARTIFACT_ID}"

	# Update the license checksums
	find "${LICENSES_DIR}" -type f -name "${FILENAME}-3.*.jar.sha1" -delete -print
	JAR_NAME="${FILENAME}-${VERSION}.jar"
	sha1sum "${WEBAPP_LIBS_DIR}/${JAR_NAME}" | awk '{ print $1 }' > "${LICENSES_DIR}/${JAR_NAME}.sha1"
done
ok "Remediation complete"
